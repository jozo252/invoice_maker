{% extends "base.html" %}

{% block content %}
<div class="container py-5">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Faktúra č.: {{ invoice.invoice_number }}</h1>
    <a href="#" class="btn btn-outline-secondary no-print" onclick="window.print()" title="Tlačiť">
      <i class="fas fa-print"></i>
    </a>
  </div>

  <!-- Parties -->
  <div class="row">
    <div class="col-md-6">
      <h4>Dodávateľ</h4>
      <p><strong>{{ invoice.company.name }}</strong></p>
      <p>{{ invoice.company.street }}</p>
      <p>{{ invoice.company.zip_code }} {{ invoice.company.city }}</p>
      <p>{{ invoice.company.country }}</p>
      <p>IČO: {{ invoice.company.ico }}</p>
      <p>DIČ: {{ invoice.company.dic }}</p>
      {% if invoice.company.is_vat_payer and invoice.company.ic_dph %}
        <p>IČ DPH: {{ invoice.company.ic_dph }}</p>
      {% else %}
        <p><em>Dodávateľ nie je platiteľom DPH</em></p>
      {% endif %}
      <p>Email: {{ invoice.company.email }}</p>
      <p>Telefón: {{ invoice.company.phone }}</p>
      <p>IBAN: {{ invoice.company.iban }}</p>
      <p>BIC/SWIFT: {{ invoice.company.bic }}</p>
    </div>

    <div class="col-md-6">
      <h4>Odberateľ</h4>
      <p><strong>{{ invoice.client.name }}</strong></p>
      <p>{{ invoice.client.street }}</p>
      <p>{{ invoice.client.zip_code }} {{ invoice.client.city }}</p>
      <p>{{ invoice.client.country }}</p>
      <p>IČO: {{ invoice.client.ico }}</p>
      <p>DIČ: {{ invoice.client.dic }}</p>
      {% if invoice.client.ic_dph %}
        <p>IČ DPH: {{ invoice.client.ic_dph }}</p>
      {% else %}
        <p><em>Odberateľ nie je platiteľom DPH</em></p>
      {% endif %}
      {% if invoice.client.email %}<p>Email: {{ invoice.client.email }}</p>{% endif %}
      {% if invoice.client.phone %}<p>Telefón: {{ invoice.client.phone }}</p>{% endif %}
      {% if invoice.client.iban %}<p>IBAN: {{ invoice.client.iban }}</p>{% endif %}
      {% if invoice.client.bic %}<p>BIC/SWIFT: {{ invoice.client.bic }}</p>{% endif %}
    </div>
  </div>

  <!-- Payment & dates -->
  <div class="card my-4 p-3">

    <p><strong>Spôsob úhrady:</strong>
      {% if invoice.payment_method.value == 'bank_transfer' %}
  <div class="d-flex align-items-start flex-wrap gap-4" style="page-break-inside: avoid;">
    <!-- Ľavý blok: IBAN/BIC -->
    <div class="pe-3">
      <p class="mb-1"><strong>IBAN:</strong> {{ invoice.company.iban }}</p>
      <p class="mb-0"><strong>BIC:</strong> {{ invoice.company.bic }}</p>
    </div>

    <!-- Pravý blok: QR -->
    {% if qr_svg %}
      <div class="ms-auto text-center" style="min-width: 180px;">
        <div style="width:170px">{{ qr_svg|safe }}</div>
        <div class="text-muted small mt-1">
          IBAN: {{ invoice.company.iban }} • VS: {{ invoice.invoice_number }}
        </div>
      </div>
    {% endif %}
  </div>


    {% endif %}

    <div class="row text-center">
      <div class="col">
        <small class="text-muted">Dátum vystavenia</small>
        <div><strong>{{ invoice.date.strftime('%d.%m.%Y') }}</strong></div>
      </div>
      <div class="col">
        <small class="text-muted">Dátum dodania</small>
        <div><strong>{{ invoice.date.strftime('%d.%m.%Y') }}</strong></div>
      </div>
      <div class="col">
        <small class="text-muted">Splatnosť faktúry</small>
        <div><strong>{{ invoice.due_date.strftime('%d.%m.%Y') }}</strong></div>
      </div>
    </div>
  </div>

  <!-- Items -->
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>Popis</th>
        <th class="text-end">Množstvo</th>
        <th>MJ</th>
        <th class="text-end">Cena za MJ</th>
        <th class="text-end">Celkom</th>
      </tr>
    </thead>
    <tbody>
      {% for item in invoice.items %}
      <tr>
        <td>{{ item.description }}</td>
        <td class="text-end">{{ item.quantity }}</td>
        <td>{{ item.unit or '' }}</td>
        <td class="text-end">{{ "%.2f"|format(item.price_per_item) }} {{ invoice.currency }}</td>
        <td class="text-end">{{ "%.2f"|format(item.total_cost) }} {{ invoice.currency }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Totals -->
  {% if invoice.company.is_vat_payer %}
    {% set vat_amount = (invoice.total_cost * invoice.vat_rate / 100) %}
    {% set total_with_vat = (invoice.total_cost + vat_amount) %}
    <div class="mt-3">
      <p>Základ DPH: {{ "%.2f"|format(invoice.total_cost) }} {{ invoice.currency }}</p>
      <p>Sadzba DPH: {{ "%.2f"|format(invoice.vat_rate) }}%</p>
      <p>DPH: {{ "%.2f"|format(vat_amount) }} {{ invoice.currency }}</p>
      <h4>Spolu na úhradu: {{ "%.2f"|format(total_with_vat) }} {{ invoice.currency }}</h4>
    </div>
  {% else %}
    <h4 class="mt-3 text-end">Celkom: {{ "%.2f"|format(invoice.total_cost) }} {{ invoice.currency }}</h4>
  {% endif %}

  <!-- Signatures -->
  <div class="row mt-5">
    <div class="col text-center">
      <strong>Vyhotovil:</strong><br>
      <img src="{{ url_for('static', filename='stamp.png') }}" alt="Stamp" style="max-height: 80px;"><br>
      <hr class="w-50 mx-auto">
    </div>
    <div class="col text-center">
      <strong>Prevzal:</strong><br><br><br><br>
      <hr class="w-50 mx-auto">
    </div>
  </div>

</div>
{% endblock %}
