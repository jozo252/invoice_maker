{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h2>Welcome, {{ current_user.username }} üëã</h2>
<a href="{{ url_for('main.create_checkout_session') }}" class="btn btn-success">Z√≠ska≈• predplatn√©</a>

  <div class="row mt-4">
    <div class="col-md-6">
      <a href="{{ url_for('main.add_invoice') }}" class="btn btn-primary btn-lg w-100 mb-3">
        ‚ûï Create New Invoice
      </a>
    </div>
    <div class="col-md-6">
      <a href="{{ url_for('main.list_invoices') }}" class="btn btn-outline-secondary btn-lg w-100 mb-3">
        üìÑ View All Invoices
      </a>
    </div>
  </div>

  <hr>

  <h4 class="mt-4">Recent Invoices</h4>

<form method="get" class="row g-2 align-items-center mb-2">
  <div class="col-auto">
    <input type="text" class="form-control" name="q" placeholder="Hƒæada≈• ƒç√≠slo, klienta alebo menu" value="{{ q or '' }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary" type="submit">Find</button>
    {% if q %}
      <a class="btn btn-outline-secondary" href="{{ url_for('main.dashboard') }}">Reset</a>
    {% endif %}
  </div>
</form>

<style>
  /* sticky header v scroll boxe */
  .table-sticky thead th { position: sticky; top: 0; z-index: 1;
    background-color: var(--bs-body-bg, #fff); }
</style>

{% if invoices %}
  <div class="table-responsive" style="max-height:420px; overflow-y:auto;">
    <table class="table table-striped table-hover mb-0 table-sticky">
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Client</th>
          <th>Date</th>
          <th>Total</th>
          <th>D√°tum splatnosti</th>
          <th>Status</th>
          <th>Akcie</th>
        </tr>
      </thead>
      <tbody>
        {% for invoice in invoices %}
        <tr>
          <td>{{ invoice.invoice_number }}</td>
          <td>{{ invoice.client.name }}</td>
          <td>{{ invoice.date.strftime('%d.%m.%Y') }}</td>
          <td>{{ "%.2f"|format(invoice.total_cost) }} {{ invoice.currency }}</td>
          <td>{{ invoice.due_date.strftime('%d.%m.%Y') }}</td>
          <td>
            {% if invoice.status == InvoiceStatus.paid %}
              <span class="badge bg-success">Zaplaten√©</span>
            {% elif invoice.is_overdue %}
              <span class="badge bg-danger">Po splatnosti: {{ invoice.days_overdue }} dni</span>
            {% else %}
              <span class="badge bg-warning">Splatnos≈• o {{ invoice.days_until_due }} dn√≠</span>
            {% endif %}
          </td>
         <td class="text-nowrap">


          <form method="POST" action="{{ url_for('main.mark_invoice_paid', id=invoice.id) }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="ti ti-cash"></i> Zaplaten√°
            </button>
          </form>
            <a href="{{ url_for('main.view_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-primary">
              <i class="ti ti-eye"></i> Zobrazi≈•
            </a>
            
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-muted">≈Ωiadne fakt√∫ry.</div>
{% endif %}


<h2>Status by client (last 12 months)</h2>
<div id="statusByClientWrap">
  <canvas id="statusByClient" width="20em" height="0em"></canvas>
  <div id="statusByClientEmpty" style="display:none;opacity:.7">No invoices in period.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function () {
  const url = "{{ url_for('main.status_by_client') }}?months=12&top=8";
  const res = await fetch(url, { credentials: 'same-origin' });
  if (!res.ok) {
      document.getElementById('statusByClient').style.display = 'none';
      document.getElementById('statusByClientEmpty').textContent = 'Not authorized or session expired.';
      document.getElementById('statusByClientEmpty').style.display = 'block';
      return;
  }
  let payload;
  try { payload = await res.json(); } catch { payload = null; }
  if (!payload || !payload.labels.length) {
      document.getElementById('statusByClient').style.display = 'none';
      document.getElementById('statusByClientEmpty').style.display = 'block';
      return;
  }

  let { labels, datasets, currency } = payload;

  // ---- spoƒç√≠tame celkov√Ω Paid a Unpaid z datasetov ----
  const lower = s => (s || '').toLowerCase();
  const sum = arr => (arr || []).reduce((a, b) => a + (Number(b) || 0), 0);

  const paidDS   = datasets.find(d => lower(d.label) === 'paid');
  const unpaidDS = datasets.find(d => lower(d.label) === 'unpaid');

  const totalPaid   = sum(paidDS?.data);
  const totalUnpaid = sum(unpaidDS?.data);

  // ---- prid√°me jeden stƒ∫pec "TOTAL" (append na koniec; ak chce≈° hore, nahraƒè push -> unshift) ----
  const labelsWithTotal = [...labels, 'TOTAL'];
  const newDatasets = datasets.map(ds => {
    const isPaid = lower(ds.label) === 'paid';
    const isUnpaid = lower(ds.label) === 'unpaid';
    const extra = isPaid ? totalPaid : isUnpaid ? totalUnpaid : 0;

    return {
      ...ds,
      // farby: Paid modr√°, Unpaid ƒçerven√°
      backgroundColor: isPaid ? 'rgba(54, 162, 235, 0.7)'
                       : isUnpaid ? 'rgba(255, 99, 132, 0.7)'
                       : ds.backgroundColor,
      borderColor:     isPaid ? 'rgba(54, 162, 235, 1)'
                       : isUnpaid ? 'rgba(255, 99, 132, 1)'
                       : ds.borderColor,
      borderWidth: 1,
      data: [...ds.data, extra] // ak by si chcel "TOTAL" navrch, pou≈æij unshift(extra) a labels unshift('TOTAL')
    };
  });

  const ctx = document.getElementById('statusByClient').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labelsWithTotal,
      datasets: newDatasets
    },
    options: {
      responsive: true,
      indexAxis: 'y', // horizont√°lne
      scales: {
        x: {
          stacked: true,
          ticks: {
            callback: (v) =>
              new Intl.NumberFormat(undefined, {
                style: 'currency',
                currency: currency || 'EUR',
                maximumFractionDigits: 0
              }).format(v)
          }
        },
        y: { stacked: true }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const val = ctx.parsed.x; // horizont√°lny bar
              const cur = currency || 'EUR';
              return `${ctx.dataset.label}: ` +
                new Intl.NumberFormat(undefined, { style: 'currency', currency: cur }).format(val);
            },
            footer: (items) => {
              const sumX = items.reduce((acc, it) => acc + it.parsed.x, 0);
              const cur = currency || 'EUR';
              return 'Total: ' + new Intl.NumberFormat(undefined, { style: 'currency', currency: cur }).format(sumX);
            }
          }
        }
      }
    }
  });
})();
</script>


</div>
{% endblock %}

